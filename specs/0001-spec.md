# 车辆入侵检测系统（IDPS）需求规格说明书

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档编号 | IDPS-SPEC-0001 |
| 文档版本 | v1.0 |
| 创建日期 | 2026-01-14 |
| 文档状态 | 草案 |
| 项目名称 | 车辆入侵检测系统（Intrusion Detection and Prevention System） |

## 1. 项目概述

### 1.1 项目背景

基于开源网络入侵检测引擎Suricata，开发适用于车载环境的入侵检测系统，为智能网联汽车提供全方位的网络安全防护能力。系统支持运行于车载ARMv8架构平台，满足车规级性能和可靠性要求。

### 1.2 项目目标

- 构建车云协同的入侵检测防护体系
- 实现网络流量、主机行为、防火墙的综合监控
- 支持云端规则下发和车端日志上报
- 满足汽车行业开源合规要求
- 实现ARM64架构的高性能运行

### 1.3 目标平台

- **车端硬件平台**：ARMv8（ARM64）架构
- **操作系统**：Linux/Android
- **部署环境**：车载计算平台（T-Box、车机、域控制器等）

## 2. 系统整体架构

### 2.1 架构概览

系统采用云端-车端两层架构设计：

```
┌─────────────────────────────────────────────────────────┐
│                        云端平台                          │
│  ┌─────────────┐              ┌──────────────┐         │
│  │   前端系统   │◄────────────►│   后端系统    │         │
│  │  规则管理    │              │  规则下发     │         │
│  │  日志展示    │              │  日志接收     │         │
│  └─────────────┘              └──────────────┘         │
└─────────────────────┬───────────────────────────────────┘
                      │ HTTPS双向认证
                      │ JSON协议
┌─────────────────────▼───────────────────────────────────┐
│                        车端系统                          │
│  ┌─────────────────────────────────────────────────┐   │
│  │            车云交互组件（私有代码）               │   │
│  │  - 身份注册认证  - 策略更新  - 日志上报          │   │
│  └──┬────────────────────────┬─────────────────┬──┘   │
│     │                        │                 │       │
│  ┌──▼────────────┐  ┌───────▼────────┐  ┌────▼──────┐│
│  │网络入侵检测    │  │   防火墙探针    │  │主机入侵   ││
│  │   引擎探针     │  │  (私有代码)     │  │检测探针   ││
│  │┌─────────────┐│  │                 │  │(私有代码) ││
│  ││ Suricata    ││  │                 │  │           ││
│  ││ (GPL组件)   ││  │                 │  │           ││
│  │└─────────────┘│  │                 │  │           ││
│  │┌─────────────┐│  │                 │  │           ││
│  ││管理服务     ││  │                 │  │           ││
│  ││(私有代码)   ││  │                 │  │           ││
│  │└─────────────┘│  │                 │  │           ││
│  └───────────────┘  └─────────────────┘  └───────────┘│
│           │                  │                  │       │
│           └──────────────────┴──────────────────┘       │
│                    进程隔离 + IPC通信 + TCP Socket                    │
└─────────────────────────────────────────────────────────┘
```

### 2.2 开源合规设计原则

为避免GPL协议传染，系统采用以下隔离策略：

1. **进程隔离**：Suricata作为独立进程运行，与私有代码物理隔离
2. **标准IPC通信**：通过Socket、文件、命令行等标准接口通信
3. **明确边界**：GPL组件与私有代码保持清晰的接口边界
4. **许可证审查**：所有第三方组件需通过开源许可证合规性审查
5. **TCP Socket通信**: 车云交互组件和各探针间采用tcp协议通信，车云交互组件作为服务端，探针作为客户端，采用epoll等技术实现

支持的IPC通信方式：
- Unix Domain Socket
- 文件系统（配置文件、日志文件）
- 命令行参数
- 标准输入输出重定向

## 3. 开发与测试环境

### 3.1 开发环境搭建

#### 3.1.1 宿主机开发环境

**操作系统**：
- Ubuntu 24.04 LTS

**工具链**：
```bash
# ARM64交叉编译工具链
apt-get install gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

# 或使用专用工具链
# aarch64-linux-gnu-gcc 9.x+
```

**依赖库**（需准备ARM64版本）：
- libpcap (网络抓包)
- libyaml (配置解析)
- libjansson (JSON处理)
- libpcre (正则表达式)
- liblz4 (压缩)
- libmagic (文件类型识别)
- libcap-ng (Linux capability)
- libnet (网络包构造)

#### 3.1.2 Suricata编译配置

```bash
# 配置交叉编译
./configure --host=aarch64-linux-gnu \
    --enable-nfqueue \
    --enable-lua \
    --with-libpcap-includes=/path/to/arm64/libpcap/include \
    --with-libpcap-libraries=/path/to/arm64/libpcap/lib

# 编译
make -j$(nproc)
make install-full DESTDIR=/path/to/arm64/rootfs
```

### 3.2 测试环境搭建

#### 3.2.1 Docker测试环境

使用ARM64 Docker容器进行功能验证：

```bash
# 拉取ARM64基础镜像
docker pull arm64v8/ubuntu:20.04

# 运行容器
docker run --rm -it \
    --platform linux/arm64 \
    -v $(pwd):/workspace \
    --cap-add=NET_ADMIN \
    --cap-add=NET_RAW \
    arm64v8/ubuntu:20.04 /bin/bash
```

#### 3.2.2 测试用例覆盖

- **单元测试**：各模块独立功能测试
- **集成测试**：车云通信、探针协作测试
- **性能测试**：CPU、内存、网络吞吐量测试
- **压力测试**：高流量、大量连接场景测试
- **兼容性测试**：不同ARM64平台适配测试

## 4. 云端平台功能需求

### 4.1 前端系统

#### 4.1.1 规则管理界面

**功能描述**：
- 规则编辑器，支持Suricata规则语法高亮
- 规则版本管理（创建、编辑、删除、发布）
- 规则分类管理（网络、防火墙、主机）
- 规则测试验证
- 规则下发历史查询

**页面要素**：
- 规则列表（表格展示，支持搜索、筛选、排序）
- 规则编辑器（代码编辑器，支持语法检查）
- 版本对比（diff视图）
- 下发记录（时间、目标车辆、状态）

#### 4.1.2 日志展示界面

**功能描述**：
- 实时日志流展示
- 日志检索与过滤（时间范围、VIN、事件类型、严重等级）
- 日志详情查看
- 统计图表（事件趋势、攻击类型分布、车辆风险排行）
- 告警配置与通知

**页面要素**：
- 日志列表（虚拟滚动，支持大数据量）
- 搜索框（支持复杂条件组合）
- 图表面板（ECharts可视化）
- 详情抽屉（JSON格式化展示）

### 4.2 后端系统

#### 4.2.1 规则下发服务

**API接口**：
```
POST /api/v1/rules/publish
- 功能：发布规则版本
- 请求参数：规则内容、版本号、目标车辆列表
- 返回：发布任务ID

GET /api/v1/rules/version/{version}
- 功能：获取指定版本规则
- 请求参数：版本号
- 返回：规则内容、元数据
```

**规则存储**：
- 关系型数据库（MySQL）

**日志存储**：
- 列数据库（Clickhouse）

#### 4.2.2 日志接收服务

**API接口**：
```
POST /api/v1/logs/upload
- 功能：接收车端上报日志
- 请求参数：VIN、日志数据（JSON数组）
- 返回：接收确认、去重结果

POST /api/v1/logs/batch
- 功能：批量日志上报
- 请求参数：VIN、日志批次数据
- 返回：批次ID、失败记录
```

**日志处理流程**：
1. 接收验证：签名校验、格式验证
2. 去重过滤：基于事件指纹去重
3. 入库存储：列数据库（Clickhouse）
4. 实时推送：WebSocket推送至前端
5. 告警触发：匹配告警规则，发送通知

#### 4.2.3 车辆管理服务

**API接口**：
```
POST /api/v1/vehicle/register
- 功能：车辆身份注册
- 请求参数：VIN、SN、设备指纹等
- 返回：授权令牌、配置信息

GET /api/v1/vehicle/info/{vin}
- 功能：获取车辆信息
- 请求参数：VIN
- 返回：车辆详细信息、组件版本
```

**数据模型**：
```sql
CREATE TABLE vehicles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    vin VARCHAR(17) UNIQUE NOT NULL,
    sn VARCHAR(64),
    device_fingerprint VARCHAR(128),
    asset_model VARCHAR(64),
    idps_version VARCHAR(32),
    os_info VARCHAR(128),
    hardware_version VARCHAR(32),
    firmware_version VARCHAR(32),
    soct VARCHAR(64),
    status TINYINT DEFAULT 1,
    register_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_heartbeat TIMESTAMP,
    INDEX idx_vin (vin),
    INDEX idx_status (status)
);
```

## 5. 车端系统功能需求

### 5.1 车云交互组件

#### 5.1.1 身份注册认证模块

**触发时机**：
- 车辆点火启动
- 车机加电
- 周期性心跳（每5分钟）

**上报信息**：
```json
{
  "vin": "LSGBF53T1EW123456",
  "sn": "SN20260114001",
  "fingerprint": "a1b2c3d4e5f6...",
  "asset_model": "ModelX-2026",
  "idps_component_code": "IDPS-ARM64-001",
  "idps_component_version": "v1.2.3",
  "os_info": {
    "name": "Linux",
    "version": "5.10.0",
    "kernel": "5.10.0-aarch64"
  },
  "hardware_version": "HW-v2.1",
  "firmware_version": "FW-v3.0.5",
  "soct": "20260114-083000",
  "timestamp": 1705208400,
  "signature": "..."
}
```

**认证流程**：
1. 车端发起注册请求（HTTPS POST）
2. 云端验证车辆身份（VIN合法性、设备指纹）
3. 云端返回授权令牌（JWT Token）
4. 车端保存令牌，激活监控功能
5. 注册失败，监控功能保持禁用状态

**安全措施**：
- HTTPS双向认证（客户端证书+服务端证书）
- 请求签名（HMAC-SHA256）
- 设备指纹防伪（基于硬件特征生成）
- 令牌有效期管理（7天，支持续期）

#### 5.1.2 策略更新模块

**更新机制**：
- **主动拉取**：每5分钟（支持配置）检查云端策略版本
- **增量更新**：支持差异化策略下发，减少流量消耗

**策略类型**：
1. 网络入侵检测规则（Suricata rules）
2. 防火墙策略（JSON格式）
3. 主机监控规则（JSON格式）

**策略文件格式**：
```json
{
  "version": "1.2.3",
  "type": "network|firewall|host",
  "timestamp": 1705208400,
  "signature": "...",
  "checksum": "sha256:...",
  "content": "规则内容或base64编码"
}
```

**更新流程**：
1. 车端请求策略版本信息（cmd=20）
2. 云端返回最新版本号和下载URL
3. 车端对比本地版本，决定是否下载
4. 下载策略文件（cmd=21）
5. 校验完整性（SHA256 checksum）
6. 验证签名（防篡改）
7. 保存至加密存储
8. 通知各探针热加载新策略

**存储安全**：
- 文件加密：AES-256-GCM
- 防篡改：数字签名（RSA-2048或ECDSA）
- 完整性校验：SHA256哈希

#### 5.1.3 日志上报模块

**日志收集**：
- 从网络入侵检测引擎探针接收
- 从防火墙探针接收
- 从主机探针接收

**日志处理**：
```
原始日志 → 格式归一化 → 去重过滤 → 压缩 → 加密 → 上报队列
```

**去重策略**：
- 时间窗口去重（5分钟内相同事件合并）
- 事件指纹去重（基于关键字段生成MD5）
- 频率限制（同一事件1分钟内最多上报10次）

**上报策略**：
- **实时上报**：高危事件（严重等级≥4）
- **批量上报**：低危事件（每5分钟一批）
- **离线缓存**：网络异常时本地队列缓存（最大100MB）
- **断点续传**：网络恢复后自动补传

**通信协议**：

请求格式（cmd=10/11）：
```json
{
  "cmd": 10,  // 10:日志上报请求, 11:批量日志上报
  "vin": "LSGBF53T1EW123456",
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "timestamp": 1705208400,
  "logs": [
    {
      "id": "log-uuid-001",
      "timestamp": 1705208300,
      "probe": "network|firewall|host",
      "event_type": "alert",
      "severity": 3,
      "source_ip": "192.168.1.100",
      "dest_ip": "10.0.0.5",
      "protocol": "TCP",
      "message": "TCP SYN flood detected",
      "details": {
        // 详细信息
      }
    }
  ],
  "signature": "..."
}
```

响应格式：
```json
{
  "code": 0,  // 0:成功, 非0:失败
  "message": "success",
  "data": {
    "received_count": 15,
    "duplicated_count": 2,
    "failed_ids": []
  }
}
```

#### 5.1.4 通信协议规范

**协议类型**：HTTPS双向认证 + JSON

**命令码定义**：
| 命令码 | 方向 | 功能 | 请求/响应 |
|--------|------|------|-----------|
| 1 | 车→云 | 车辆注册 | 请求 |
| 2 | 云→车 | 注册响应 | 响应 |
| 10 | 车→云 | 日志上报 | 请求 |
| 11 | 云→车 | 上报响应 | 响应 |
| 20 | 车→云 | 策略版本查询 | 请求 |
| 21 | 云→车 | 策略下发 | 响应 |
| 30 | 车→云 | 心跳 | 请求 |
| 31 | 云→车 | 心跳响应 | 响应 |

**请求通用头**：
```json
{
  "cmd": 1,
  "vin": "LSGBF53T1EW123456",
  "token": "...",
  "timestamp": 1705208400,
  "nonce": "随机数",
  "signature": "HMAC-SHA256签名"
}
```

**响应通用格式**：
```json
{
  "code": 0,
  "message": "success",
  "data": {},
  "timestamp": 1705208400
}
```

**错误码定义**：
| 错误码 | 含义 | 处理建议 |
|--------|------|----------|
| 0 | 成功 | - |
| 1001 | 参数错误 | 检查请求参数 |
| 1002 | 签名验证失败 | 检查签名算法和密钥 |
| 1003 | Token无效或过期 | 重新注册获取Token |
| 1004 | VIN未注册 | 执行车辆注册流程 |
| 2001 | 策略版本不存在 | 使用本地缓存策略 |
| 5000 | 服务器内部错误 | 稍后重试 |

### 5.2 网络入侵检测引擎探针

#### 5.2.1 Suricata引擎集成

**组件版本**：
- Suricata 7.x（GPL许可证）
- 运行模式：IDS模式（被动监听）
- 抓包方式：AF_PACKET（Linux）或libpcap

**配置文件**：`/etc/suricata/suricata.yaml`

关键配置项：
```yaml
# 监听网卡
af-packet:
  - interface: eth0
    cluster-id: 99
    cluster-type: cluster_flow
    defrag: yes
  - interface: wlan0
    cluster-id: 98
    cluster-type: cluster_flow

# 输出配置
outputs:
  - eve-log:
      enabled: yes
      filetype: regular
      filename: /var/log/suricata/eve.json
      types:
        - alert
        - http
        - dns
        - tls
        - files
        - smtp
        - ssh
        - flow

# 应用层协议
app-layer:
  protocols:
    http:
      enabled: yes
    dns:
      enabled: yes
    tls:
      enabled: yes
    mqtt:
      enabled: yes
```

#### 5.2.2 规则管理

**规则存储路径**：
- 内置规则：`/etc/suricata/rules/builtin/`
- 云端规则：`/etc/suricata/rules/cloud/`
- 本地规则：`/etc/suricata/rules/local/`

**规则加载优先级**：云端规则 > 本地规则 > 内置规则

**热加载机制**：
```bash
# 通过USR2信号触发规则重载
kill -USR2 $(cat /var/run/suricata.pid)

# 或使用suricatasc命令
suricatasc -c "reload-rules"
```

**规则格式**：Suricata标准语法

示例：
```
alert tcp any any -> $HOME_NET any (msg:"TCP SYN flood attack"; \
    flags:S; threshold:type threshold, track by_dst, count 100, seconds 1; \
    classtype:attempted-dos; sid:1000001; rev:1;)
```

#### 5.2.3 以太网入侵检测

**支持协议层**：
- 数据链路层（L2）：Ethernet II、IEEE 802.3
- 网络层（L3）：IPv4、IPv6、ICMP、ARP
- 传输层（L4）：TCP、UDP、SCTP
- 应用层（L7）：HTTP、DNS、TLS、MQTT等

**检测方法**：
- 特征匹配：基于规则的模式匹配
- 协议异常：协议标准违反检测
- 流量分析：连接状态跟踪、流量统计

**日志输出格式**：EVE JSON

示例：
```json
{
  "timestamp": "2026-01-14T08:30:00.123456+0000",
  "flow_id": 1234567890,
  "event_type": "alert",
  "src_ip": "192.168.1.100",
  "src_port": 54321,
  "dest_ip": "10.0.0.5",
  "dest_port": 80,
  "proto": "TCP",
  "alert": {
    "action": "allowed",
    "gid": 1,
    "signature_id": 1000001,
    "rev": 1,
    "signature": "TCP SYN flood attack",
    "category": "Attempted DoS",
    "severity": 3
  }
}
```

#### 5.2.4 DPI深度包检测

**支持协议**：

1. **SOME/IP**（ISO 20077）
   - 服务发现（SD）
   - RPC调用
   - 事件通知
   - 字段订阅

2. **DoIP**（ISO 13400）
   - 车辆识别
   - 诊断消息路由
   - UDS协议承载

3. **HTTP/HTTPS**
   - 请求方法检测
   - URI路径检测
   - User-Agent检测
   - Cookie检测

4. **TLS**
   - 证书验证
   - 协议版本检测
   - 加密套件检测

5. **DNS**
   - 域名黑名单
   - DNS隧道检测
   - DGA域名检测

6. **MQTT**
   - Client ID检测
   - Topic订阅检测
   - 消息内容检测

**DPI规则示例**：

MQTT协议检测：
```
alert mqtt any any -> any any (msg:"MQTT illegal Client ID"; \
    mqtt.connect.client.id; content:"e23f53bb22"; \
    classtype:misc-attack; sid:5000019; rev:1;)
```

SOME/IP服务检测：
```
alert someip any any -> any any (msg:"SOME/IP unauthorized service access"; \
    someip.service_id:0x1234; someip.method_id:0x5678; \
    classtype:policy-violation; sid:5000020; rev:1;)
```

DoIP诊断服务检测：
```
alert doip any any -> any any (msg:"DoIP unauthorized diagnostic request"; \
    doip.payload_type:0x8001; content:"|10 03|"; \
    classtype:attempted-admin; sid:5000021; rev:1;)
```

#### 5.2.5 安全事件监控

**事件类型与代号**：

| 事件类型 | 事件代号 | 严重等级 | 说明 |
|----------|----------|----------|------|
| TCP land攻击 | 101 | 高 | 源IP/端口与目的IP/端口相同 |
| TCP ACK flood攻击 | 102 | 高 | ACK包洪泛 |
| TCP畸形报文攻击 | 103 | 中 | TCP头部异常 |
| TCP SYN flood攻击 | 104 | 高 | SYN洪泛攻击 |
| TCP数据包异常 | 105 | 低 | TCP包异常特征 |
| UDP flood攻击 | 106 | 高 | UDP洪泛攻击 |
| UDP畸形报文攻击 | 107 | 中 | UDP头部异常 |
| UDP数据包异常 | 108 | 低 | UDP包异常特征 |
| ICMP flood攻击 | 109 | 中 | ICMP洪泛 |
| Large ping攻击 | 110 | 中 | 超大ICMP包 |
| IGMP flood攻击 | 111 | 中 | IGMP洪泛 |
| DoIP协议异常 | 201 | 高 | DoIP协议违规 |
| MQTT协议异常 | 212 | 中 | MQTT协议违规 |
| GB/T 32960.3异常 | 203 | 中 | 新能源车监控协议异常 |
| SOME/IP异常 | 204 | 高 | SOME/IP协议违规 |
| Telnet弱密码 | 301 | 高 | 弱口令登录 |
| FTP弱密码 | 302 | 高 | 弱口令登录 |
| 杂项攻击 | 900 | - | 其他类型攻击 |
| 漏洞利用 | 1000 | 严重 | CVE漏洞利用 |

**规则示例**：

TCP SYN flood检测：
```
alert tcp any any -> any any (msg:"TCP SYN flood attack detected"; \
    flags:S; threshold:type threshold, track by_dst, count 100, seconds 1; \
    classtype:attempted-dos; metadata:event_code 104; sid:1000104; rev:1;)
```

MQTT非法Client ID检测：
```
alert mqtt any any -> any any (msg:"MQTT illegal Client ID:e23f53bb221e4d75b362f01936238841"; \
    mqtt.connect.client.id; content:"e23f53bb22"; \
    classtype:misc-attack; metadata:event_code 212; sid:5000019; rev:1;)
```

#### 5.2.6 管理服务（私有代码）

**功能职责**：
- 启动/停止/重启Suricata进程
- 监控Suricata运行状态（进程存活、日志输出）
- 接收云端规则并写入Suricata规则目录
- 触发Suricata规则热加载
- 读取EVE JSON日志并转发至车云交互组件
- 异常处理（进程崩溃重启、日志轮转）

**通信接口**：
- 与Suricata：命令行启动、Unix信号、日志文件
- 与车云交互组件：TCP Socket

**进程守护**：
```c
// 伪代码
while (true) {
    if (!is_suricata_running()) {
        start_suricata();
        log("Suricata restarted");
    }
    if (has_new_rules()) {
        deploy_rules();
        reload_suricata_rules();
        log("Rules reloaded");
    }
    if (has_new_logs()) {
        read_and_forward_logs();
    }
    sleep(5);
}
```

### 5.3 防火墙探针

**实现方式**：
- eBPF + XDP

#### 5.3.1 流量监控和统计

**监控维度**：
- 进程级别：每个进程的上传/下载流量
- 网卡级别：4G/5G/WiFi/Ethernet
- 时间维度：实时、小时、日


**统计数据结构**：
```json
{
  "timestamp": 1705208400,
  "pid": 1234,
  "process_name": "com.example.app",
  "uid": 10001,
  "interface": "wlan0",  // 4g0/5g0/wlan0/eth0
  "rx_bytes": 1048576,
  "tx_bytes": 524288,
  "rx_packets": 1000,
  "tx_packets": 500,
  "duration": 3600
}
```

**上报策略**：
- 周期：每5分钟
- 聚合：按进程、网卡、小时聚合
- 压缩：批量上报时使用gzip压缩

#### 5.3.2 非法请求拦截

**整体策略模式**：

| 模式 | 默认行为 | 规则作用 | 适用场景 |
|------|----------|----------|----------|
| 阻断模式 | 拒绝所有 | allow放行特例 | 高安全环境（白名单） |
| 告警模式 | 检测不拦截 | allow跳过检测，deny拒绝 | 测试环境 |
| 放行模式 | 允许所有 | deny拒绝特例 | 正常使用（黑名单） |

**规则配置格式**：
```json
{
  "policy_mode": "block|alert|allow",
  "rules": [
    {
      "id": 1,
      "enabled": true,
      "direction": "in|out|both",
      "action": "allow|deny",
      "src_ip": "192.168.1.0/24",
      "dst_ip": "10.0.0.5",
      "src_port": "any",
      "dst_port": "80,443",
      "protocol": "tcp|udp|icmp|any",
      "comment": "允许内网访问Web服务"
    }
  ]
}
```

**事件上报**：
```json
{
  "event_type": "firewall_block",
  "timestamp": 1705208400,
  "rule_id": 1,
  "direction": "out",
  "src_ip": "192.168.1.100",
  "src_port": 54321,
  "dst_ip": "8.8.8.8",
  "dst_port": 53,
  "protocol": "udp",
  "pid": 1234,
  "process": "com.example.app",
  "action": "deny",
  "reason": "匹配阻断规则"
}
```

#### 5.3.3 应用联网控制

**功能描述**：
- 配置特定APP/bin允许或禁止联网
- 区分WiFi和蜂窝网络
- 前台/后台联网控制

**配置格式**：
```json
{
  "apps": [
    {
      "package_name": "com.example.app",
      "uid": 10001,
      "wifi_allowed": true,
      "cellular_allowed": false,
      "background_allowed": false,
      "action": "alert|block"
    }
  ]
}
```

**事件上报**：
```json
{
  "event_type": "app_network_control",
  "timestamp": 1705208400,
  "package_name": "com.example.app",
  "uid": 10001,
  "network_type": "cellular",
  "action": "block",
  "reason": "蜂窝网络联网被禁止"
}
```

#### 5.3.4 传输层协议状态监控和拦截

**功能描述**：
- 跟踪TCP连接状态
- 识别非本机主动发起的连接（被动连接）
- 拦截未授权的入站连接

**连接状态表**：
```c
struct connection_state {
    uint32_t src_ip;
    uint16_t src_port;
    uint32_t dst_ip;
    uint16_t dst_port;
    uint8_t protocol;
    uint8_t direction;  // 0:outbound, 1:inbound
    uint8_t initiated;  // 0:passive, 1:active
    time_t create_time;
};
```

**检测逻辑**：
```
if (packet.direction == INBOUND &&
    packet.flags == SYN &&
    !is_in_connection_table(packet)) {
    // 非本机主动发起的连接
    log_event("Unauthorized inbound connection");
    return NF_DROP;
}
```

**事件上报**：
```json
{
  "event_type": "unauthorized_connection",
  "timestamp": 1705208400,
  "src_ip": "203.0.113.10",
  "src_port": 12345,
  "dst_ip": "192.168.1.100",
  "dst_port": 22,
  "protocol": "tcp",
  "action": "block"
}
```

#### 5.3.5 服务漏洞刺探监控和拦截

**功能描述**：
- 检测端口扫描行为
- 统计短时间内对同一端口的访问次数
- 超过阈值时拦截并告警

**配置参数**：
```json
{
  "threshold": {
    "count": 10,
    "time_window": 60,
    "action": "alert|block"
  }
}
```

**检测算法**：
```python
# 伪代码
port_access_counter = {}  # {(src_ip, dst_port): [timestamp1, timestamp2, ...]}

def check_port_scan(packet):
    key = (packet.src_ip, packet.dst_port)
    now = time.time()

    # 清理超过时间窗口的记录
    port_access_counter[key] = [
        t for t in port_access_counter.get(key, [])
        if now - t < TIME_WINDOW
    ]

    # 添加当前访问
    port_access_counter[key].append(now)

    # 检查是否超过阈值
    if len(port_access_counter[key]) > THRESHOLD:
        log_event("Port scan detected")
        return True
    return False
```

**事件上报**：
```json
{
  "event_type": "port_scan",
  "timestamp": 1705208400,
  "src_ip": "203.0.113.10",
  "dst_port": 22,
  "access_count": 15,
  "time_window": 60,
  "action": "block"
}
```

#### 5.3.6 ARP欺骗监控

**功能描述**：
- 统计ARP请求和响应数量
- 检测ARP响应与请求的比例异常
- 检测ARP缓存投毒攻击

**监控指标**：
```json
{
  "arp_request_sent": 100,
  "arp_reply_received": 98,
  "arp_request_received": 5,
  "arp_reply_sent": 5,
  "abnormal_ratio": false
}
```

**检测逻辑**：
```python
# ARP欺骗检测
if abs(arp_reply_received - arp_request_sent) > THRESHOLD:
    log_event("ARP spoofing detected")

# ARP缓存投毒检测
if arp_request_received > THRESHOLD * 10:
    log_event("ARP cache poisoning detected")
```

**阈值配置**：
```json
{
  "arp_monitoring": {
    "ratio_threshold": 20,
    "flood_threshold": 100,
    "time_window": 60
  }
}
```

**事件上报**：
```json
{
  "event_type": "arp_spoofing",
  "timestamp": 1705208400,
  "arp_request_sent": 100,
  "arp_reply_received": 125,
  "difference": 25,
  "threshold": 20,
  "action": "alert"
}
```

#### 5.3.7 ICMP时间戳探活监控

**功能描述**：
- 检测ICMP Timestamp Request（type 13）
- 检测ICMP Timestamp Reply（type 14）
- 防止信息泄露（系统时间）

**检测逻辑**：
```c
if (icmp_header->type == ICMP_TIMESTAMP) {
    log_event("ICMP timestamp request detected");
    return NF_DROP;  // 可配置为DROP或ACCEPT
}
```

**配置选项**：
```json
{
  "icmp_timestamp": {
    "action": "alert|block",
    "log_enabled": true
  }
}
```

**事件上报**：
```json
{
  "event_type": "icmp_timestamp",
  "timestamp": 1705208400,
  "src_ip": "203.0.113.10",
  "dst_ip": "192.168.1.100",
  "icmp_type": 13,
  "action": "block"
}
```

#### 5.3.8 TCP连接数监控

**功能描述**：
- 统计到同一目的IP的TCP连接数
- 超过阈值时告警（可能是连接泄露或攻击）
- 周期性上报TCP连接统计

**监控维度**：
```json
{
  "per_dest_ip": {
    "10.0.0.5": {
      "established": 50,
      "syn_sent": 5,
      "time_wait": 20
    }
  },
  "total": {
    "established": 200,
    "syn_sent": 10,
    "time_wait": 50
  }
}
```

**阈值配置**：
```json
{
  "tcp_connection": {
    "max_per_dest_ip": 100,
    "max_total": 1000,
    "report_interval": 300
  }
}
```

**事件上报**：
```json
{
  "event_type": "tcp_connection_limit",
  "timestamp": 1705208400,
  "dest_ip": "10.0.0.5",
  "connection_count": 120,
  "threshold": 100,
  "action": "alert"
}
```

#### 5.3.9 APN监控

**功能描述**：
- 识别数据包使用的网络接入点（WiFi/4G/5G/USB）
- 记录不同APN的流量分布
- 周期性上报APN使用统计

**网卡与APN映射**：
```json
{
  "apn_mapping": {
    "wlan0": "WiFi",
    "rmnet_data0": "4G",
    "rmnet_data1": "5G",
    "rndis0": "USB"
  }
}
```

**统计数据**：
```json
{
  "timestamp": 1705208400,
  "apn_stats": [
    {
      "apn": "WiFi",
      "interface": "wlan0",
      "rx_bytes": 10485760,
      "tx_bytes": 5242880,
      "connection_count": 50
    },
    {
      "apn": "4G",
      "interface": "rmnet_data0",
      "rx_bytes": 2097152,
      "tx_bytes": 1048576,
      "connection_count": 10
    }
  ]
}
```

**上报周期**：每5分钟

### 5.4 主机入侵检测探针

#### 5.4.1 Audit监控

**功能描述**：
- 监控系统调用（syscall）
- 监控敏感命令执行
- 基于规则过滤和告警

**系统调用监控规则**：
```json
{
  "rule": [
    {
      "process": "mediaserver",
      "syscallid": ["270", "271", "117", "279", "40"]
    }
  ]
}
```

系统调用ID说明（ARM64）：
- 270: `pkey_mprotect`（内存保护）
- 271: `pkey_alloc`（内存密钥分配）
- 117: `ptrace`（进程跟踪）
- 279: `finit_module`（加载内核模块）
- 40: `mount`（挂载文件系统）

**命令监控规则**：
```json
{
  "cmd": ["su", "rm", "killall", "chmod", "chown"]
}
```

**实现方式**：
- Linux Audit子系统（auditd）
- 系统调用跟踪（strace/ptrace）
- 进程监控（/proc文件系统）

**auditd规则配置**：
```bash
# /etc/audit/rules.d/idps.rules
-a exit,always -F arch=b64 -S ptrace -k idps_ptrace
-a exit,always -F arch=b64 -S mount -k idps_mount
-a exit,always -F arch=b64 -S finit_module -k idps_module
-w /usr/bin/su -p x -k idps_su
-w /bin/rm -p x -k idps_rm
```

**事件日志格式**：
```json
{
  "event_type": "audit_syscall",
  "timestamp": 1705208400,
  "pid": 1234,
  "process": "mediaserver",
  "syscall": "ptrace",
  "syscall_id": 117,
  "uid": 1000,
  "gid": 1000,
  "args": ["PTRACE_ATTACH", "5678"],
  "result": "success"
}
```

#### 5.4.2 文件监控

**功能描述**：
- 监控文件和目录的创建、删除、修改、重命名
- 支持递归监控目录
- 基于inotify实现

**监控规则**：
```json
{
  "path": [
    "/data/misc/wifi/WifiConfigStore.xml",
    "/data/data/com.android.providers.contacts/databases/contacts2.db",
    "/etc/passwd",
    "/etc/shadow",
    "/system/bin/",
    "/data/app/"
  ]
}
```

**监控事件类型**：
- `IN_CREATE`：文件/目录创建
- `IN_DELETE`：文件/目录删除
- `IN_MODIFY`：文件内容修改
- `IN_ATTRIB`：文件属性修改
- `IN_MOVED_FROM`/`IN_MOVED_TO`：文件重命名/移动

**实现代码（伪代码）**：
```c
int fd = inotify_init();
for (const char* path : monitored_paths) {
    int wd = inotify_add_watch(fd, path,
        IN_CREATE | IN_DELETE | IN_MODIFY | IN_ATTRIB | IN_MOVE);
}

while (true) {
    struct inotify_event event;
    read(fd, &event, sizeof(event));
    log_event(event);
}
```

**事件日志格式**：
```json
{
  "event_type": "file_modification",
  "timestamp": 1705208400,
  "path": "/data/misc/wifi/WifiConfigStore.xml",
  "operation": "modify",
  "pid": 1234,
  "process": "system_server",
  "uid": 1000,
  "old_hash": "sha256:abc123...",
  "new_hash": "sha256:def456..."
}
```

#### 5.4.3 进程监控

**功能描述**：
- 监控指定进程的CPU和内存占用
- 检测进程是否处于调试状态
- 监控IDPS自身资源占用，防止资源耗尽

**监控规则**：
```json
{
  "mem": 301,  // 全局内存阈值（MB）
  "process": [
    {
      "name": "mediaserver",
      "mem": 100,  // 进程内存阈值（MB）
      "cpu": 40    // CPU占用阈值（%）
    },
    {
      "name": "system_server",
      "mem": 200,
      "cpu": 50
    }
  ]
}
```

**监控项**：
1. CPU占用率（%）
2. 内存占用（RSS/VSS）
3. 调试状态（TracerPid）
4. 进程状态（Running/Sleeping/Zombie）

**实现方式**：
```bash
# CPU占用
top -b -n 1 | grep <process_name>

# 内存占用
cat /proc/<pid>/status | grep -E "VmRSS|VmSize"

# 调试状态
cat /proc/<pid>/status | grep TracerPid
# TracerPid != 0 表示被调试
```

**IDPS自身资源保护**：
```c
// 伪代码
void check_self_resource() {
    float cpu_usage = get_cpu_usage(getpid());
    int mem_usage_mb = get_memory_usage_mb(getpid());

    if (cpu_usage > 80.0 || mem_usage_mb > 500) {
        log_critical("IDPS resource exhaustion, restarting...");
        // 优雅退出，由守护进程重启
        cleanup_and_exit();
    }
}
```

**事件日志格式**：
```json
{
  "event_type": "process_resource_alert",
  "timestamp": 1705208400,
  "pid": 1234,
  "process": "mediaserver",
  "cpu_percent": 45.2,
  "mem_mb": 120,
  "threshold_cpu": 40,
  "threshold_mem": 100,
  "action": "alert"
}
```

**调试检测日志**：
```json
{
  "event_type": "process_debug_detected",
  "timestamp": 1705208400,
  "pid": 1234,
  "process": "system_server",
  "tracer_pid": 5678,
  "tracer_name": "gdb",
  "action": "alert"
}
```

#### 5.4.4 性能监控组件

**功能描述**：
- 周期性检查系统性能指标
- 监控CPU、内存、磁盘、IOPS
- 监控IDPS自身性能

**监控规则**：
```json
{
  "cycle": 1800,  // 检查周期（秒）
  "item": ["cpu", "disk", "ram", "iops", "idps", "top"]
}
```

**监控项说明**：

| item | 监控内容 | 数据来源 |
|------|----------|----------|
| cpu | CPU使用率、负载 | `/proc/stat`, `/proc/loadavg` |
| ram | 内存使用率、可用内存 | `/proc/meminfo` |
| disk | 磁盘使用率、剩余空间 | `df -h` |
| iops | 磁盘IOPS | `/proc/diskstats` |
| idps | IDPS进程CPU/内存 | `/proc/<pid>/stat` |
| top | CPU占用TOP6进程 | `top -b -n 1` |

**性能数据格式**：
```json
{
  "timestamp": 1705208400,
  "performance": {
    "cpu": {
      "usage_percent": 35.2,
      "load_average": [1.5, 1.2, 1.0],
      "core_count": 8
    },
    "ram": {
      "total_mb": 4096,
      "used_mb": 2048,
      "free_mb": 2048,
      "usage_percent": 50.0
    },
    "disk": {
      "partitions": [
        {
          "mount": "/",
          "total_gb": 32,
          "used_gb": 18,
          "free_gb": 14,
          "usage_percent": 56.3
        }
      ]
    },
    "iops": {
      "read_iops": 150,
      "write_iops": 80
    },
    "idps": {
      "cpu_percent": 5.2,
      "mem_mb": 80,
      "status": "normal"
    },
    "top_processes": [
      {"name": "system_server", "cpu": 12.5},
      {"name": "mediaserver", "cpu": 8.3},
      {"name": "surfaceflinger", "cpu": 6.7}
    ]
  }
}
```

**实现代码（CPU监控）**：
```c
// 读取 /proc/stat
struct cpu_info {
    unsigned long user, nice, system, idle, iowait, irq, softirq;
};

float calculate_cpu_usage(struct cpu_info* prev, struct cpu_info* curr) {
    unsigned long prev_idle = prev->idle + prev->iowait;
    unsigned long curr_idle = curr->idle + curr->iowait;

    unsigned long prev_total = prev->user + prev->nice + prev->system +
                               prev->idle + prev->iowait + prev->irq + prev->softirq;
    unsigned long curr_total = curr->user + curr->nice + curr->system +
                               curr->idle + curr->iowait + curr->irq + curr->softirq;

    unsigned long total_diff = curr_total - prev_total;
    unsigned long idle_diff = curr_idle - prev_idle;

    return (float)(total_diff - idle_diff) / total_diff * 100.0;
}
```

#### 5.4.5 系统Root监控

**功能描述**：
- 检测系统是否被Root
- 检测Root工具和超级用户APP
- 检测系统属性篡改

**监控规则**：
```json
{
  "cycle": 300,  // 检查周期（秒）
  "instruct": [
    "/system/bin/su",
    "/system/xbin/su",
    "/sbin/su",
    "/system/su",
    "/vendor/bin/su"
  ],
  "superapks": [
    "com.noshufou.android.su",
    "com.topjohnwu.magisk",
    "eu.chainfire.supersu",
    "com.koushikdutta.superuser",
    "com.thirdparty.superuser"
  ],
  "properties": {
    "ro.secure": 0,
    "ro.debuggable": 1,
    "service.adb.root": 1
  }
}
```

**检测维度**：

1. **Su二进制文件检测**：
```bash
# 检查常见su路径
for path in ${instruct[@]}; do
    if [ -f "$path" ]; then
        echo "Root detected: $path exists"
    fi
done
```

2. **Root APP检测**：
```bash
# 检查已安装应用
pm list packages | grep -E "supersu|magisk|superuser"
```

3. **系统属性检测**：
```bash
# 检查安全属性
getprop ro.secure        # 应该为1（secure）
getprop ro.debuggable    # 应该为0（non-debuggable）
getprop service.adb.root # 应该为0（adb非root）
```

4. **SELinux状态检测**：
```bash
# 检查SELinux状态
getenforce  # 应该为Enforcing，不应该为Permissive/Disabled
```

**Root检测结果**：
```json
{
  "event_type": "root_detection",
  "timestamp": 1705208400,
  "is_rooted": true,
  "indicators": [
    {
      "type": "binary",
      "path": "/system/xbin/su",
      "exists": true
    },
    {
      "type": "app",
      "package": "com.topjohnwu.magisk",
      "installed": true
    },
    {
      "type": "property",
      "key": "ro.debuggable",
      "expected": 0,
      "actual": 1
    }
  ],
  "action": "alert"
}
```

## 6. 数据模型与存储

### 6.1 车端数据存储

#### 6.1.1 策略文件存储

**存储路径**：
```
/data/idps/
├── config/
│   ├── network_rules.json      # 网络规则
│   ├── firewall_policy.json    # 防火墙策略
│   ├── host_audit_rules.json   # 主机审计规则
│   └── version.json             # 版本信息
├── certs/
│   ├── client.crt               # 客户端证书
│   ├── client.key               # 客户端私钥
│   └── ca.crt                   # CA证书
└── cache/
    └── logs/                    # 离线日志缓存
```

**加密存储**：
- 算法：AES-256-GCM
- 密钥管理：基于设备硬件派生密钥（HDKF）
- 完整性：HMAC-SHA256

**版本信息格式**：
```json
{
  "network_rules_version": "1.2.3",
  "firewall_policy_version": "2.0.1",
  "host_audit_rules_version": "1.5.0",
  "last_update": 1705208400,
  "checksum": {
    "network_rules": "sha256:...",
    "firewall_policy": "sha256:...",
    "host_audit_rules": "sha256:..."
  }
}
```

#### 6.1.2 日志缓存存储

**缓存策略**：
- 最大容量：100MB
- 清理策略：FIFO（先进先出）
- 持久化：周期性写入磁盘（每5分钟或缓存满10MB）

**缓存文件格式**：
```
/data/idps/cache/logs/
├── 20260114_0830.log.gz
├── 20260114_0835.log.gz
└── 20260114_0840.log.gz
```

### 6.2 云端数据存储

#### 6.2.1 数据库设计

**车辆信息表**（vehicles）：
```sql
CREATE TABLE vehicles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    vin VARCHAR(17) UNIQUE NOT NULL,
    sn VARCHAR(64),
    device_fingerprint VARCHAR(128),
    asset_model VARCHAR(64),
    idps_version VARCHAR(32),
    os_info JSON,
    hardware_version VARCHAR(32),
    firmware_version VARCHAR(32),
    soct VARCHAR(64),
    status TINYINT DEFAULT 1,  -- 1:active, 0:inactive
    register_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_heartbeat TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_vin (vin),
    INDEX idx_status (status),
    INDEX idx_last_heartbeat (last_heartbeat)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**规则版本表**（rule_versions）：
```sql
CREATE TABLE rule_versions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    version VARCHAR(32) UNIQUE NOT NULL,
    rule_type VARCHAR(32) NOT NULL,  -- network/firewall/host
    content_url VARCHAR(256),
    content_hash VARCHAR(64),
    file_size INT,
    description TEXT,
    status TINYINT DEFAULT 1,  -- 1:published, 0:draft
    created_by VARCHAR(64),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    published_at TIMESTAMP,
    INDEX idx_version (version),
    INDEX idx_rule_type (rule_type),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**规则下发记录表**（rule_deployments）：
```sql
CREATE TABLE rule_deployments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    version_id BIGINT NOT NULL,
    vin VARCHAR(17) NOT NULL,
    status TINYINT DEFAULT 0,  -- 0:pending, 1:success, 2:failed
    deploy_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP,
    error_message TEXT,
    INDEX idx_version_id (version_id),
    INDEX idx_vin (vin),
    INDEX idx_status (status),
    FOREIGN KEY (version_id) REFERENCES rule_versions(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**日志事件表**（列数据库 - ClickHouse


## 7. 接口规范

### 7.1 车云通信接口

**基础URL**：`https://vsoc.example.com/api/v1`

#### 7.1.1 车辆注册接口

**请求**：
```
POST /vehicle/register
Content-Type: application/json

{
  "cmd": 1,
  "vin": "LSGBF53T1EW123456",
  "sn": "SN20260114001",
  "device_fingerprint": "a1b2c3d4e5f6...",
  "asset_model": "ModelX-2026",
  "idps_component_code": "IDPS-ARM64-001",
  "idps_component_version": "v1.2.3",
  "os_info": {
    "name": "Linux",
    "version": "5.10.0"
  },
  "hardware_version": "HW-v2.1",
  "firmware_version": "FW-v3.0.5",
  "soct": "20260114-083000",
  "timestamp": 1705208400,
  "nonce": "abc123",
  "signature": "..."
}
```

**响应**：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_expires_at": 1705812000,
    "config": {
      "log_upload_interval": 300,
      "rule_check_interval": 3600,
      "heartbeat_interval": 86400
    }
  },
  "timestamp": 1705208400
}
```

#### 7.1.2 策略查询接口

**请求**：
```
POST /rule/query
Content-Type: application/json

{
  "cmd": 20,
  "vin": "LSGBF53T1EW123456",
  "token": "...",
  "rule_type": "network",
  "current_version": "1.2.2",
  "timestamp": 1705208400,
  "signature": "..."
}
```

**响应**：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "latest_version": "1.2.3",
    "need_update": true,
    "download_url": "https://vsoc.example.com/rules/network/1.2.3",
    "file_size": 102400,
    "checksum": "sha256:...",
    "signature": "..."
  },
  "timestamp": 1705208400
}
```

#### 7.1.3 策略下载接口

**请求**：
```
GET /rule/download?version=1.2.3&type=network
Authorization: Bearer <token>
```

**响应**：
```
HTTP/1.1 200 OK
Content-Type: application/octet-stream
Content-Disposition: attachment; filename="network_rules_1.2.3.json"
X-Checksum: sha256:...
X-Signature: ...

<规则文件内容>
```

#### 7.1.4 日志上报接口

**请求**：
```
POST /log/upload
Content-Type: application/json

{
  "cmd": 10,
  "vin": "LSGBF53T1EW123456",
  "token": "...",
  "timestamp": 1705208400,
  "logs": [
    {
      "id": "log-uuid-001",
      "timestamp": 1705208300,
      "probe": "network",
      "event_type": "alert",
      "severity": 3,
      "source_ip": "192.168.1.100",
      "dest_ip": "10.0.0.5",
      "protocol": "TCP",
      "message": "TCP SYN flood detected",
      "details": {}
    }
  ],
  "signature": "..."
}
```

**响应**：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "received_count": 1,
    "duplicated_count": 0,
    "failed_ids": []
  },
  "timestamp": 1705208400
}
```

### 7.2 车端内部接口

#### 7.2.1 探针与交互组件接口（TCP Socket）


#### 7.2.2 Suricata管理接口

**suricatasc控制接口**（Unix Socket）：
```bash
# /var/run/suricata/suricata-command.socket
echo '{"command": "reload-rules"}' | nc -U /var/run/suricata/suricata-command.socket
```

**EVE日志接口**（文件）：
```
/var/log/suricata/eve.json
```

## 8. 安全设计

### 8.1 通信安全

**双向TLS认证**：
- 客户端证书：车端持有，由CA签发
- 服务端证书：云端持有，由CA签发
- CA证书：双方持有，用于验证对方证书

**证书格式**：X.509 v3

**加密套件**（推荐）：
- TLS 1.3: `TLS_AES_256_GCM_SHA384`
- TLS 1.2: `ECDHE-RSA-AES256-GCM-SHA384`

### 8.2 数据安全

**传输加密**：
- 协议：TLS 1.2+
- 对称加密：AES-256-GCM
- 密钥交换：ECDHE（椭圆曲线Diffie-Hellman）

**存储加密**：
- 车端配置文件：AES-256-GCM
- 日志缓存：AES-256-GCM（可选）
- 密钥派生：PBKDF2或HKDF

**数据完整性**：
- 签名算法：HMAC-SHA256或RSA-SHA256
- 哈希算法：SHA-256

### 8.3 身份认证

**车辆身份认证**：
- VIN合法性验证（校验位计算）
- 设备指纹验证（硬件特征绑定）
- 客户端证书验证

**Token机制**：
- 类型：JWT（JSON Web Token）
- 算法：HS256或RS256
- 有效期：7天
- 刷新机制：过期前24小时可续期

### 8.4 授权控制

**车辆授权状态**：
- 已授权：监控功能启用
- 未授权：监控功能禁用
- 授权过期：进入宽限期（7天），提示续期

**功能降级策略**：
- 注册失败：使用本地缓存策略，仅记录日志不上报
- Token过期：停止日志上报，继续本地监控
- 网络异常：离线缓存，恢复后补传

## 9. 性能要求

### 9.1 车端性能

**资源占用**：
- CPU：平均≤10%，峰值≤30%（4核ARMv8）
- 内存：≤200MB（常驻）
- 磁盘：≤100MB（日志缓存）
- 网络：上行≤10KB/s（平均），下行≤5KB/s

**实时性**：
- 数据包处理延迟：≤10ms
- 事件检测延迟：≤100ms
- 日志上报延迟：高危≤1s，普通≤5min

**可靠性**：
- 进程崩溃自动重启时间：≤5s
- 日志丢失率：≤0.1%
- 策略更新成功率：≥99%

### 9.2 云端性能

**并发能力**：
- 同时在线车辆：10,000+
- 日志写入TPS：10,000+
- API响应时间：P99≤500ms

**数据存储**：
- 日志保留期：180天（热数据），1年（冷数据）
- 数据库备份：每日全量备份
- 容灾：异地多活

## 10. 部署要求

### 10.1 车端部署

**系统要求**：
- 架构：ARMv8（aarch64）
- Linux内核：≥4.14

**安装包结构**：
```
idps-arm64-v1.2.3.tar.gz
├── bin/
│   ├── idps-daemon          # 主守护进程
│   ├── network-probe        # 网络探针
│   ├── firewall-probe       # 防火墙探针
│   ├── host-probe           # 主机探针
│   └── suricata             # Suricata引擎
├── lib/
│   └── libsuricata.so.*     # 依赖库
├── etc/
│   ├── idps.conf            # 主配置
│   ├── suricata.yaml        # Suricata配置
│   └── rules/               # 内置规则
├── certs/
│   └── ca.crt               # CA证书
└── scripts/
    ├── install.sh           # 安装脚本
    └── uninstall.sh         # 卸载脚本
```

**安装步骤**：
```bash
tar -xzf idps-arm64-v1.2.3.tar.gz
cd idps-arm64-v1.2.3
sudo ./scripts/install.sh
```

**服务启动**：
```bash
# 或 init.d
/etc/init.d/idps start
```

### 10.2 云端部署

**基础设施**：
- 容器编排：Kubernetes
- 服务网格：Istio（可选）
- 监控：Prometheus + Grafana
- 日志：ELK Stack

**微服务架构**：
```
├── frontend-service         # 前端服务
├── api-gateway              # API网关
├── auth-service             # 认证服务
├── rule-service             # 规则服务
├── log-service              # 日志服务
├── vehicle-service          # 车辆管理服务
└── notification-service     # 通知服务
```

**部署配置（Kubernetes）**：
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: log-service
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: log-service
        image: idps/log-service:v1.2.3
        resources:
          limits:
            cpu: "2"
            memory: "4Gi"
          requests:
            cpu: "1"
            memory: "2Gi"
```

## 11. 测试计划

### 11.1 单元测试

**测试覆盖率目标**：≥80%

**测试框架**：
- C/C++: Google Test
- Python: pytest
- Go: testing包

### 11.2 集成测试

**测试场景**：
- 车云通信：注册、策略更新、日志上报
- 探针协作：日志收集、规则同步
- 故障恢复：进程重启、网络恢复

### 11.3 性能测试

**测试工具**：
- 网络流量生成：tcpreplay
- 压力测试：JMeter、Locust
- 性能分析：perf、valgrind

**测试场景**：
- 高流量：100Mbps网络流量
- 大连接：10,000并发TCP连接
- 长时间运行：7×24小时稳定性测试

### 11.4 安全测试

**测试内容**：
- 漏洞扫描：静态代码分析（Coverity、SonarQube）
- 渗透测试：模拟攻击场景
- 模糊测试：输入数据Fuzzing

## 12. 交付物

### 12.1 代码交付

**代码仓库结构**：
```
idps/
├── cloud/                   # 云端代码
│   ├── frontend/
│   ├── backend/
│   └── deployment/
├── vehicle/                 # 车端代码
│   ├── daemon/
│   ├── network-probe/
│   ├── firewall-probe/
│   ├── host-probe/
│   └── cloud-connector/
├── suricata/                # Suricata集成
│   ├── patches/
│   └── configs/
├── tests/                   # 测试代码
├── docs/                    # 文档
└── tools/                   # 工具脚本
```

### 12.2 文档交付

**文档清单**：
1. 需求规格说明书（本文档）
2. 详细设计文档
3. 接口设计文档
4. 部署手册
5. 运维手册
6. 用户手册
7. 测试报告
8. 开源许可证声明

### 12.3 安装包交付

**车端安装包**：
- `idps-arm64-v1.2.3.tar.gz`

**云端部署包**：
- Docker镜像（每个微服务）
- Kubernetes YAML配置
- Helm Charts

## 13. 里程碑计划

| 阶段 | 任务 | 交付物 | 时长 |
|------|------|--------|------|
| Phase 1 | 开发环境搭建<br>Suricata交叉编译<br>基础框架搭建 | 编译工具链<br>运行框架 | - |
| Phase 2 | 网络入侵检测模块<br>Suricata集成与规则管理 | 网络探针<br>规则热加载 | - |
| Phase 3 | 防火墙模块<br>流量控制与拦截 | 防火墙探针<br>策略引擎 | - |
| Phase 4 | 主机入侵检测模块<br>Audit与文件监控 | 主机探针<br>监控规则 | - |
| Phase 5 | 车云交互组件<br>通信协议实现 | 交互组件<br>协议实现 | - |
| Phase 6 | 云端平台开发<br>前后端系统 | 云端平台<br>管理界面 | - |
| Phase 7 | 集成测试<br>性能优化 | 测试报告<br>优化方案 | - |
| Phase 8 | 安全测试<br>部署验证 | 安全报告<br>部署文档 | - |

## 14. 风险与应对

### 14.1 技术风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| ARM平台性能不足 | 高 | 中 | 性能优化，功能降级 |
| Suricata规则不兼容 | 中 | 低 | 规则适配，自定义解析器 |
| GPL许可证传染 | 高 | 低 | 严格进程隔离，法律审查 |

### 14.2 业务风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 车端资源受限 | 中 | 中 | 功能裁剪，资源限制 |
| 网络不稳定 | 中 | 高 | 离线缓存，断点续传 |
| 误报率过高 | 高 | 中 | 规则调优，白名单机制 |

## 15. 附录

### 15.1 术语表

| 术语 | 全称 | 说明 |
|------|------|------|
| IDPS | Intrusion Detection and Prevention System | 入侵检测与防御系统 |
| Suricata | - | 开源网络IDS/IPS引擎 |
| DPI | Deep Packet Inspection | 深度包检测 |
| SOME/IP | Scalable service-Oriented MiddlewarE over IP | 车载以太网通信协议 |
| DoIP | Diagnostics over IP | IP诊断协议 |
| VIN | Vehicle Identification Number | 车辆识别代码 |
| APN | Access Point Name | 接入点名称 |
| EVE JSON | Extensible Event Format | Suricata日志格式 |
| NFQUEUE | Netfilter Queue | Linux网络过滤队列 |

### 15.2 参考文档

1. Suricata官方文档：https://suricata.io/docs/
2. ISO 13400 (DoIP标准)
3. ISO 20077 (SOME/IP标准)
4. GB/T 32960.3 (新能源汽车监控协议)
5. OWASP Top 10
6. GPL v2协议文本
7. Linux Audit文档

### 15.3 变更记录

| 版本 | 日期 | 修改人 | 修改内容 |
|------|------|--------|----------|
| v1.0 | 2026-01-14 | - | 初始版本 |

---

**文档结束**
