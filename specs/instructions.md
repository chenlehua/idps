# Instructions

## 需求生成

基于Suricata开发车辆入侵检测系统，支持运行于车载ARMv8架构平台

1、开发环境搭建
2、测试环境搭建 使用交叉编译生成ARM64二进制，在ARM64 Docker容器中进行功能验证。
3、整体架构 整个程序分为两大部分：云端部分和车端部分。
4、云端部分 包括前端和后端：
支持规则的编辑和下发，区分版本
支持接收车端上报的日志，并实时展示

5、车端部分 包括以下模块：
网络入侵检测引擎探针（SURICATA-GPL组件、SURICATA管理服务-私有代码）
防火墙探针
主机入侵检测探针
车云交互组件

6、开源合规设计 车端组件引入的外部组件需要开源合规，采用规避GPL传染的架构设计。通过
进程隔离和标准IPC通信（socket、文件、命令行），让私有代码与GPL组件保持"井水不犯河水"的边界，避免GPL传染。

7、车云交互
实现车辆点火启动时的云端身份注册认证，通过上报车辆关键信息（VIN、SN、设备指纹、资产型号、IDPS组件代码、IDPS组件版本、操作系统信息、硬件版本、固件版本、SOCT等）获取授权，注册成功后激活车端监控组件功能。
触发时机：车辆点火启动、车机加电
核心功能：车辆身份注册与授权验证
关键信息：VIN、SN、设备指纹、组件版本、硬件/固件信息等
控制逻辑：注册成功→监控功能启用；注册失败→监控功能不生效
构建车机端日志上报组件，实现从多个监控探针收集日志、支持策略化去重过滤、安全加密存储及可靠上传至云端平台的完整能力。
构建车端策略更新组件，实现安全策略文件的版本化管理、加密存储、防篡改校验及云端周期性更新能力，支持多监控探动态获取策略以应对汽车网络安全威胁。
定义车端与云端VSOC平台的HTTPS双向认证通信协议规范，基于JSON格式实现策略更新、日志上报的请求-响应交互；业务类型规则请求（cmd=20/21）、日志上报（cmd=10/11）

8、网络入侵检测引擎
8.1 规则管理 内置基础规则，云端下发规则支持热加载。
8.2 以太网入侵检测 解析2到7层数据包，匹配入侵检测策略，生成入侵检测安全日志。
8.3 DPI深度包检测 支持对SOME/IP、DoIP、HTTP、TLS、DNS等应用层协议的深度包解析，按照协议字段配置的规则对报文进行检测，产生安全事件日志。
8.4 安全事件监控 支持以下安全事件的监控，每种事件定义代号：
TCP land攻击
TCP ACK flood攻击
TCP畸形报文攻击
TCP SYN flood攻击
TCP数据包异常监控
UDP flood攻击
UDP畸形报文攻击
UDP数据包异常监控
ICMP flood攻击
Large ping攻击
IGMP flood攻击
DoIP协议监控
MQTT协议监控
GB/T 32960.3协议监控
SOME/IP协议监控
Telnet弱密码监控
FTP弱密码监控
杂项监控
漏洞检测
其中MQTT协议监控的事件代号为212，规则示例： alert mqtt any any -> any any (msg:"MQTT illegal Client ID:e23f53bb221e4d75b362f01936238841"; mqtt.connect.client.id; content:"e23f53bb22"; classtype:misc-attack; sid:5000019; rev:1;)

9、防火墙
9.1 流量监控和统计 监控车载APP/bin与外部通信所消耗的数据流量，支持进程级别统计，区分不同网卡（4G/5G/WiFi），周期性上报至云端。
9.2 非法请求拦截 命中对应规则时需要上报事件至云端，支持云端下发规则。
整体策略配置： 支持整体策略（放行、告警、阻断）的配置，支持单条源IP、目的IP、源PORT、目的PORT、PROTO五元组、方向（出方向、入方向）、执行动作的配置。
策略模式说明：
阻断模式：防火墙整体名单为白名单，可配置五元组规则为allow放行该特例
告警模式：防火墙处于检测模式，即按照阻断模式运行检测逻辑，但底层默认不对数据包进行实质性拦截。可配置allow来放弃对该五元组的检测，可配置deny来阻断该五元组的通行
放行模式：防火墙处于黑名单机制，可配置deny来阻断特定五元组
9.3 应用联网控制 支持配置APP和bin是否允许联网，告警、阻断时需要上报事件至云端；支持云端下发规则。
9.4 传输层协议状态监控和拦截 非本机主动发出的连接视为非法连接，对这些连接进行拦截，并上报事件至云端。
9.5 服务漏洞刺探监控和拦截 短期内某个相同端口有超过阈值次数的请求出现，则认定该五元组状态异常，生成事件并上报。
9.6 ARP欺骗监控 统计本机发送和接收ARP数据包的数量。当数量之差超过阈值，则认为网络中出现了ARP欺骗行为，生成事件并上报。
9.7 ICMP时间戳探活监控 解析类型为timestamp的ICMP数据包，如检测到则生成事件并上报。
9.8 TCP连接数监控 同一目的IP地址的连接数超过阈值时，产生事件，生成日志并上报。周期性获取系统内TCP连接情况并上报。
9.9 APN监控 APN指应用上网所使用的网络接入点，具体指WiFi、4G、USB通道。根据数据包的网卡名称，判断属于哪种APN，并记录日志，周期性上报。



10、主机入侵检测
10.1 Audit监控 系统调用和cmd指令监控，规则示例： {"rule":[{"process":"mediaserver","syscallid":["270","271","117","279","40"]}]} {"cmd":["su","rm","killall"]}
10.2 文件监控 采用inotify实现：
监控文件的创建、读取、写入、改名、删除
监控目录的创建、删除、改名
规则示例： {"path":["/data/misc/wifi/WifiConfigStore.xml","/data/data/com.android.providers.contacts/databases/contacts2.db"]}
10.3 进程监控
监控指定进程的CPU占用和内存占用，如果高于指定阈值则上报日志
监控进程是否为调试状态，如果是则上报日志
IDPS进程内存、CPU占用过高监控。当超出阈值时，杀死IDPS进程，后续系统会再次启动被杀死的进程
规则示例： {"mem":301,"process":[{"name":"mediaserver","mem":100,"cpu":40}]}
10.4 性能监控组件 规则示例： {"cycle":1800,"item":["cpu","disk","ram","iops","idps"]}
规则说明：item字段值为需要检查的性能信息：
包含ram：检查内存信息
包含cpu：检查CPU信息
包含disk：检查磁盘信息
包含top：检查CPU使用率最高的前6个程序
包含idps：检查IDPS程序内存和CPU使用情况
10.5 系统root监控 规则示例： {"cycle":300,"instruct":["/system/bin/su","/system/xbin/su","/sbin/su","/system/su"],"superapks":["com.noshufou.android.su","com.mhuang.overclocking","com.keramidas.TitaniumBackup","com.adbjdr991.brj991dbd"],"properties":{"ro.secure":0,"ro.debuggable":1,"service.adb.root":1}}
规则说明：
properties字段：检查系统属性值是否与检查项一致，如果一致则代表被root
instruct和superapks字段：检查系统中是否存在root程序，如果存在则代表被root


按照这个想法，帮我生成详细的需求，放在./specs/0001-spec.md 文件中, 输出为中文。



## specify con


## 详细设计

按照./specs/0001-spec.md 文件中的需求，帮我生成详细的设计文档，放在./specs/0002-design.md文件中，图表使用mermaid,输出为中文。 